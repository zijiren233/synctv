apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "synctv.configMapName" . }}
  labels:
    {{- include "synctv.labels" . | nindent 4 }}
data:
  config.yaml: |
    server:
      host: {{ .Values.config.server.host | quote }}
      http_port: {{ .Values.config.server.httpPort }}
      grpc_port: {{ .Values.config.server.grpcPort }}

    database:
      host: {{ .Values.config.database.host | quote }}
      port: {{ .Values.config.database.port }}
      name: {{ .Values.config.database.name | quote }}
      ssl_mode: {{ .Values.config.database.sslMode | quote }}
      max_connections: {{ .Values.config.database.maxConnections }}

    redis:
      host: {{ .Values.config.redis.host | quote }}
      port: {{ .Values.config.redis.port }}
      db: {{ .Values.config.redis.db }}

    cluster:
      enabled: {{ .Values.config.cluster.enabled }}
      {{- if .Values.config.cluster.enabled }}
      node_registry:
        enabled: {{ .Values.config.cluster.nodeRegistry.enabled }}
        ttl: {{ .Values.config.cluster.nodeRegistry.ttl | quote }}
      health_monitor:
        interval: {{ .Values.config.cluster.healthMonitor.interval | quote }}
      load_balancer:
        strategy: {{ .Values.config.cluster.loadBalancer.strategy | quote }}
        new_node_warmup: {{ .Values.config.cluster.loadBalancer.newNodeWarmup | quote }}
      {{- end }}

    livestream:
      rtmp_port: {{ .Values.config.livestream.rtmpPort }}
      max_streams: {{ .Values.config.livestream.maxStreams }}
      gop_cache_size: {{ .Values.config.livestream.gopCacheSize }}
      stream_timeout_seconds: {{ .Values.config.livestream.streamTimeoutSeconds }}
      cleanup_check_interval_seconds: {{ .Values.config.livestream.cleanupCheckIntervalSeconds }}

    turn:
      enabled: {{ .Values.config.turn.enabled }}
      {{- if .Values.config.turn.enabled }}
      public_ip: {{ .Values.config.turn.publicIP | quote }}
      realm: {{ .Values.config.turn.realm | quote }}
      min_port: {{ .Values.config.turn.minPort }}
      max_port: {{ .Values.config.turn.maxPort }}
      {{- end }}

    {{- if .Values.config.oauth2.providers }}
    oauth2:
      providers:
        {{- range .Values.config.oauth2.providers }}
        - name: {{ .name | quote }}
          client_id: {{ .clientId | quote }}
          redirect_url: {{ .redirectUrl | quote }}
        {{- end }}
    {{- end }}

    {{- if .Values.config.email.enabled }}
    email:
      enabled: true
      host: {{ .Values.config.email.host | quote }}
      port: {{ .Values.config.email.port }}
      from: {{ .Values.config.email.from | quote }}
    {{- end }}

    jwt:
      expires_in: {{ .Values.config.jwt.expiresIn | quote }}

    rate_limit:
      enabled: {{ .Values.config.rateLimit.enabled }}
      default_limit: {{ .Values.config.rateLimit.defaultLimit }}

    cors:
      allowed_origins:
        {{- range .Values.config.cors.allowedOrigins }}
        - {{ . | quote }}
        {{- end }}
      allow_credentials: {{ .Values.config.cors.allowCredentials }}

    logging:
      level: {{ .Values.config.logging.level | quote }}
      format: {{ .Values.config.logging.format | quote }}
