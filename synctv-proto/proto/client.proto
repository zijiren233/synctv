syntax = "proto3";

package synctv.client;

// ==================== Auth Service ====================
// Authentication: None (public access)
// Routes: /api/auth/*
service AuthService {
    rpc Register(RegisterRequest) returns (RegisterResponse);
    rpc Login(LoginRequest) returns (LoginResponse);
    rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
}

// ==================== User Service ====================
// Authentication: JWT Authorization header (user_id)
// Routes: /api/user/*
service UserService {
    // Profile Management
    rpc Logout(LogoutRequest) returns (LogoutResponse);
    rpc GetProfile(GetProfileRequest) returns (GetProfileResponse);
    rpc SetUsername(SetUsernameRequest) returns (SetUsernameResponse);
    rpc SetPassword(SetPasswordRequest) returns (SetPasswordResponse);

    // User's Rooms
    rpc ListCreatedRooms(ListCreatedRoomsRequest) returns (ListCreatedRoomsResponse);
    rpc ListParticipatedRooms(ListParticipatedRoomsRequest) returns (ListParticipatedRoomsResponse);
}

// ==================== Room Service ====================
// Authentication: JWT Authorization header (user_id) + x-room-id metadata (room context)
// Routes: /api/room/*
service RoomService {
    // Room Management (resource-targeted operations)
    rpc CreateRoom(CreateRoomRequest) returns (CreateRoomResponse);
    rpc GetRoom(GetRoomRequest) returns (GetRoomResponse);
    rpc JoinRoom(JoinRoomRequest) returns (JoinRoomResponse);
    rpc LeaveRoom(LeaveRoomRequest) returns (LeaveRoomResponse);
    rpc DeleteRoom(DeleteRoomRequest) returns (DeleteRoomResponse);
    rpc SetRoomSettings(SetRoomSettingsRequest) returns (SetRoomSettingsResponse);

    // Member Management (room-scoped operations, use x-room-id)
    rpc GetRoomMembers(GetRoomMembersRequest) returns (GetRoomMembersResponse);
    rpc SetMemberPermission(SetMemberPermissionRequest) returns (SetMemberPermissionResponse);
    rpc KickMember(KickMemberRequest) returns (KickMemberResponse);

    // Real-time Messaging (room-scoped, use x-room-id)
    rpc MessageStream(stream ClientMessage) returns (stream ServerMessage);
    rpc GetChatHistory(GetChatHistoryRequest) returns (GetChatHistoryResponse);
}

// ==================== Media Service ====================
// Authentication: JWT Authorization header (user_id) + x-room-id metadata (room context)
// Routes: /api/room/media/*
service MediaService {
    // Playlist Management (room-scoped operations, use x-room-id)
    rpc CreatePlaylist(CreatePlaylistRequest) returns (CreatePlaylistResponse);
    rpc SetPlaylist(SetPlaylistRequest) returns (SetPlaylistResponse);
    rpc DeletePlaylist(DeletePlaylistRequest) returns (DeletePlaylistResponse);
    rpc GetPlaylists(GetPlaylistsRequest) returns (GetPlaylistsResponse);
    rpc SetPlaying(SetPlayingRequest) returns (SetPlayingResponse);

    // Media Management (room-scoped operations, use x-room-id)
    rpc AddMedia(AddMediaRequest) returns (AddMediaResponse);
    rpc RemoveMedia(RemoveMediaRequest) returns (RemoveMediaResponse);
    rpc GetPlaylist(GetPlaylistRequest) returns (GetPlaylistResponse);
    rpc SwapMedia(SwapMediaRequest) returns (SwapMediaResponse);

    // Playback Control (room-scoped operations, use x-room-id)
    rpc Play(PlayRequest) returns (PlayResponse);
    rpc Pause(PauseRequest) returns (PauseResponse);
    rpc Seek(SeekRequest) returns (SeekResponse);
    rpc ChangeSpeed(ChangeSpeedRequest) returns (ChangeSpeedResponse);
    rpc SwitchMedia(SwitchMediaRequest) returns (SwitchMediaResponse);
    rpc GetPlaybackState(GetPlaybackStateRequest) returns (GetPlaybackStateResponse);

    // Live Streaming (room-scoped, use x-room-id)
    rpc NewPublishKey(NewPublishKeyRequest) returns (NewPublishKeyResponse);
}

// ==================== Public Service ====================
// Authentication: None (public access)
// Routes: /api/public/*
service PublicService {
    rpc CheckRoom(CheckRoomRequest) returns (CheckRoomResponse);
    rpc ListRooms(ListRoomsRequest) returns (ListRoomsResponse);
    rpc GetHotRooms(GetHotRoomsRequest) returns (GetHotRoomsResponse);
    rpc GetPublicSettings(GetPublicSettingsRequest) returns (GetPublicSettingsResponse);
}

// ==================== Email Service ====================
// Authentication: None for sending codes, JWT for confirmation
// Routes: /api/email/*
service EmailService {
    // Email verification
    rpc SendVerificationEmail(SendVerificationEmailRequest) returns (SendVerificationEmailResponse);
    rpc ConfirmEmail(ConfirmEmailRequest) returns (ConfirmEmailResponse);

    // Password reset
    rpc RequestPasswordReset(RequestPasswordResetRequest) returns (RequestPasswordResetResponse);
    rpc ConfirmPasswordReset(ConfirmPasswordResetRequest) returns (ConfirmPasswordResetResponse);
}

// Common Types
message User {
    string id = 1;
    string username = 2;
    string email = 3;
    int64 permissions = 4;
    int64 created_at = 5;
}

message Room {
    string id = 1;
    string name = 2;
    string created_by = 3;
    string status = 4; // pending, active, banned
    bytes settings = 5; // JSON settings
    int64 created_at = 6;
    int32 member_count = 7;
}

message Media {
    string id = 1;
    string room_id = 2;
    string url = 3; // Deprecated: Use source_config instead
    string provider = 4; // bilibili, alist, emby, direct (also known as source_provider)
    string title = 5; // Also known as name
    bytes metadata = 6; // JSON metadata
    int32 position = 7; // Position in playlist
    int64 added_at = 8;
    string added_by = 9; // Also known as creator_id
    string provider_instance_name = 10; // e.g., "bilibili_main", "alist_company"
    bytes source_config = 11; // JSON source config (replaces url for flexibility)
}

message Playlist {
    string id = 1;
    string room_id = 2;
    string name = 3;
    string parent_id = 4; // Parent playlist ID for nested playlists (null for root)
    int32 position = 5; // Position among sibling playlists
    bool is_folder = 6; // True if this is a folder (can contain other playlists)
    bool is_dynamic = 7; // True if this is a dynamic playlist (provider-based)
    int32 item_count = 8; // Number of items in this playlist
    int64 created_at = 9;
    int64 updated_at = 10;
}

message PlaybackState {
    string room_id = 1;
    string playing_media_id = 2;
    double position = 3; // seconds
    double speed = 4;
    bool is_playing = 5;
    int64 updated_at = 6;
    int32 version = 7; // For optimistic locking
}

message RoomMember {
    string room_id = 1;
    string user_id = 2;
    string username = 3;
    int64 permissions = 4;
    int64 joined_at = 5;
    bool is_online = 6;
}

// Authentication Messages
message RegisterRequest {
    string username = 1;
    string password = 2;
    string email = 3;
}

message RegisterResponse {
    User user = 1;
    string access_token = 2;
    string refresh_token = 3;
}

message LoginRequest {
    string username = 1;
    string password = 2;
}

message LoginResponse {
    User user = 1;
    string access_token = 2;
    string refresh_token = 3;
}

message RefreshTokenRequest {
    string refresh_token = 1;
}

message RefreshTokenResponse {
    string access_token = 1;
    string refresh_token = 2;
}

message GetProfileRequest {}

message GetProfileResponse {
    User user = 1;
}

// Room Management Messages
message CreateRoomRequest {
    string name = 1;
    string password = 2; // Optional room password
    bytes settings = 3; // JSON settings
}

message CreateRoomResponse {
    Room room = 1;
}

message GetRoomRequest {
    string room_id = 1;
}

message GetRoomResponse {
    Room room = 1;
    PlaybackState playback_state = 2;
}

message JoinRoomRequest {
    string room_id = 1;
    string password = 2; // Optional room password
}

message JoinRoomResponse {
    Room room = 1;
    PlaybackState playback_state = 2;
    repeated RoomMember members = 3;
}

message LeaveRoomRequest {
    string room_id = 1;
}

message LeaveRoomResponse {
    bool success = 1;
}

message ListRoomsRequest {
    int32 page = 1;
    int32 page_size = 2;
}

message ListRoomsResponse {
    repeated Room rooms = 1;
    int32 total = 2;
}

message DeleteRoomRequest {
    string room_id = 1;
}

message DeleteRoomResponse {
    bool success = 1;
}

message SetRoomSettingsRequest {
    string room_id = 1;
    bytes settings = 2; // JSON settings
}

message SetRoomSettingsResponse {
    Room room = 1;
}

// Room Members Messages
// Note: room_id extracted from x-room-id metadata
message GetRoomMembersRequest {}

message GetRoomMembersResponse {
    repeated RoomMember members = 1;
}

message SetMemberPermissionRequest {
    string user_id = 1;        // Target user
    int64 permissions = 2;      // New permissions
}

message SetMemberPermissionResponse {
    RoomMember member = 1;
}

message KickMemberRequest {
    string user_id = 1;  // Target user to kick
}

message KickMemberResponse {
    bool success = 1;
}

// Playlist Management Messages
// Note: room_id extracted from x-room-id metadata

message CreatePlaylistRequest {
    string name = 1;
    string parent_id = 2; // Optional parent playlist ID for nested playlists
    bool is_folder = 3; // True if creating a folder (can contain other playlists)
}

message CreatePlaylistResponse {
    Playlist playlist = 1;
}

message SetPlaylistRequest {
    string playlist_id = 1;
    string name = 2; // Optional new name
    int32 position = 3; // Optional new position
}

message SetPlaylistResponse {
    Playlist playlist = 1;
}

message DeletePlaylistRequest {
    string playlist_id = 1;
}

message DeletePlaylistResponse {
    bool success = 1;
}

message GetPlaylistsRequest {
    string parent_id = 1; // Optional parent ID to get children of specific playlist
}

message GetPlaylistsResponse {
    repeated Playlist playlists = 1;
}

message SetPlayingRequest {
    string playlist_id = 1; // Playlist to play from
    string media_id = 2; // Optional specific media to play (if not specified, starts from first or current position)
}

message SetPlayingResponse {
    Playlist playlist = 1;
    Media playing_media = 2; // The media that is now playing
}

// Media Management Messages
// Note: room_id extracted from x-room-id metadata

message AddMediaRequest {
    string playlist_id = 1; // Target playlist ID
    string url = 2; // Deprecated: Use source_config instead
    string provider = 3; // Optional, provider type name (e.g., "bilibili", "alist")
    string provider_instance_name = 4; // Optional, specific provider instance (e.g., "bilibili_main")
    bytes source_config = 5; // JSON source config (e.g., {"url": "...", "path": "..."})
    string title = 6; // Optional media title
}

message AddMediaResponse {
    Media media = 1;
}

message RemoveMediaRequest {
    string media_id = 1;
}

message RemoveMediaResponse {
    bool success = 1;
}

message GetPlaylistRequest {
    string playlist_id = 1; // Playlist ID to get
    int32 page = 2; // Page number (default 1)
    int32 page_size = 3; // Items per page (default 50)
}

message GetPlaylistResponse {
    Playlist playlist = 1;
    repeated Media media = 2;
    int32 total = 3; // Total number of items in playlist
}

message SwapMediaRequest {
    string room_id = 1; // Room ID
    string media_id1 = 2;
    string media_id2 = 3;
}

message SwapMediaResponse {
    bool success = 1;
}

// Playback Control Messages
// Note: room_id extracted from x-room-id metadata
message PlayRequest {}

message PlayResponse {
    PlaybackState playback_state = 1;
}

message PauseRequest {}

message PauseResponse {
    PlaybackState playback_state = 1;
}

message SeekRequest {
    double position = 1; // seconds
}

message SeekResponse {
    PlaybackState playback_state = 1;
}

message ChangeSpeedRequest {
    double speed = 1; // 0.5, 1.0, 1.5, 2.0, etc.
}

message ChangeSpeedResponse {
    PlaybackState playback_state = 1;
}

message SwitchMediaRequest {
    string media_id = 1;
}

message SwitchMediaResponse {
    PlaybackState playback_state = 1;
}

message GetPlaybackStateRequest {}

message GetPlaybackStateResponse {
    PlaybackState playback_state = 1;
}

// Real-time Messaging
message ClientMessage {
    oneof message {
        ChatMessageSend chat = 1;
        DanmakuMessageSend danmaku = 2;
        HeartbeatMessage heartbeat = 3;
    }
}

message ServerMessage {
    oneof message {
        ChatMessageReceive chat = 1;
        DanmakuMessageReceive danmaku = 2;
        PlaybackStateChanged playback_state = 3;
        UserJoinedRoom user_joined = 4;
        UserLeftRoom user_left = 5;
        RoomSettingsChanged room_settings = 6;
        HeartbeatAck heartbeat_ack = 7;
        ErrorMessage error = 8;
        MediaAdded media_added = 9;
        MediaRemoved media_removed = 10;
        PermissionChanged permission_changed = 11;
        PlaylistCreated playlist_created = 12;
        PlaylistUpdated playlist_updated = 13;
        PlaylistDeleted playlist_deleted = 14;
        PlayingChanged playing_changed = 15;
    }
}

// Note: room_id extracted from x-room-id metadata in MessageStream context
message ChatMessageSend {
    string content = 1;
}

message ChatMessageReceive {
    string id = 1;
    string room_id = 2;
    string user_id = 3;
    string username = 4;
    string content = 5;
    int64 timestamp = 6;
}

// Note: room_id extracted from x-room-id metadata in MessageStream context
message DanmakuMessageSend {
    string content = 1;
    string color = 2; // hex color
    int32 position = 3; // 0=top, 1=bottom, 2=scroll
}

message DanmakuMessageReceive {
    string room_id = 1;
    string user_id = 2;
    string content = 3;
    string color = 4;
    int32 position = 5;
    int64 timestamp = 6;
}

message HeartbeatMessage {
    int64 timestamp = 1;
}

message HeartbeatAck {
    int64 timestamp = 1;
}

message PlaybackStateChanged {
    string room_id = 1;
    PlaybackState state = 2;
}

message UserJoinedRoom {
    string room_id = 1;
    RoomMember member = 2;
}

message UserLeftRoom {
    string room_id = 1;
    string user_id = 2;
}

message RoomSettingsChanged {
    string room_id = 1;
    bytes settings = 2; // JSON settings
}

message ErrorMessage {
    string code = 1;
    string message = 2;
}

// Chat History
// Note: room_id extracted from x-room-id metadata
message GetChatHistoryRequest {
    int32 limit = 1; // Max 500
    int64 before = 2; // Timestamp for pagination
}

message GetChatHistoryResponse {
    repeated ChatMessageReceive messages = 1;
}

// User Profile Management
message LogoutRequest {}

message LogoutResponse {
    bool success = 1;
}

message SetUsernameRequest {
    string new_username = 1;
}

message SetUsernameResponse {
    User user = 1;
}

message SetPasswordRequest {
    string old_password = 1;
    string new_password = 2;
}

message SetPasswordResponse {
    bool success = 1;
}

message ListCreatedRoomsRequest {
    int32 page = 1;
    int32 page_size = 2;
}

message ListCreatedRoomsResponse {
    repeated Room rooms = 1;
    int32 total = 2;
}

message ListParticipatedRoomsRequest {
    int32 page = 1;
    int32 page_size = 2;
}

message ListParticipatedRoomsResponse {
    repeated RoomWithRole rooms = 1;
    int32 total = 2;
}

message RoomWithRole {
    Room room = 1;
    int64 permissions = 2; // User's permissions in this room
    string role = 3; // creator, admin, member, guest
}

// Room Discovery
message CheckRoomRequest {
    string room_id = 1;
}

message CheckRoomResponse {
    bool exists = 1;
    bool requires_password = 2;
    string name = 3;
}

message GetHotRoomsRequest {
    int32 limit = 1; // Default 10, max 50
}

message GetHotRoomsResponse {
    repeated RoomWithStats rooms = 1;
}

message RoomWithStats {
    Room room = 1;
    int32 online_count = 2; // Current online users
    int32 total_members = 3;
}

// ==================== Live Streaming ====================

// NewPublishKey - Generate RTMP publish key for live streaming
// Note: room_id should be extracted from metadata/context by interceptor
// Note: user_id should be extracted from JWT Authorization header
message NewPublishKeyRequest {
    string id = 1;  // Media ID to publish (matches Go's IDReq pattern)
}

message NewPublishKeyResponse {
    string publish_key = 1;  // JWT token for RTMP authentication
    string rtmp_url = 2;     // Full RTMP URL (rtmp://host:port/live)
    string stream_key = 3;   // Stream key (room_id/media_id)
    int64 expires_at = 4;    // Token expiration timestamp
}

// ==================== Public Settings ====================

message GetPublicSettingsRequest {}

message GetPublicSettingsResponse {
    bool signup_enabled = 1;
    bool allow_room_creation = 2;
    int64 max_rooms_per_user = 3;
    int64 max_members_per_room = 4;
}

// ==================== Email Verification ====================

message SendVerificationEmailRequest {
    string email = 1;
}

message SendVerificationEmailResponse {
    string message = 1;
}

message ConfirmEmailRequest {
    string email = 1;
    string token = 2;  // Verification code from email
}

message ConfirmEmailResponse {
    string message = 1;
    string user_id = 2;
}

// ==================== Password Reset ====================

message RequestPasswordResetRequest {
    string email = 1;
}

message RequestPasswordResetResponse {
    string message = 1;
}

message ConfirmPasswordResetRequest {
    string email = 1;
    string token = 2;       // Reset code from email
    string new_password = 3;
}

message ConfirmPasswordResetResponse {
    string message = 1;
    string user_id = 2;
}

// ==================== Additional Server Messages ====================

message MediaAdded {
    string room_id = 1;
    string media_id = 2;
    string title = 3;
    string added_by = 4; // Username
    string added_by_user_id = 5; // User ID
}

message MediaRemoved {
    string room_id = 1;
    string media_id = 2;
    string removed_by = 4; // Username
    string removed_by_user_id = 5; // User ID
}

message PermissionChanged {
    string room_id = 1;
    string user_id = 2;
    int64 new_permissions = 3;
    string updated_by = 4; // Username of who made the change
}

// ==================== Playlist Events ====================

message PlaylistCreated {
    string room_id = 1;
    Playlist playlist = 2;
}

message PlaylistUpdated {
    string room_id = 1;
    Playlist playlist = 2;
}

message PlaylistDeleted {
    string room_id = 1;
    string playlist_id = 2;
}

message PlayingChanged {
    string room_id = 1;
    Playlist playlist = 2;
    Media playing_media = 3; // Optional: the media that started playing
}
